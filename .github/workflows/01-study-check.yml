name: Study Check Bot
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      check_result: ${{ steps.file_check.outputs.result }}
      user_name: ${{ steps.file_check.outputs.user_name }}
      file_name: ${{ steps.file_check.outputs.file_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Check user's study file
        id: file_check
        uses: actions/github-script@v6
        with:
          script: |
            const userMapping = {
              'JANGSEYEONG': 'seyeong',
              'sooyoung159': 'sooyoung',
              'kamja44': 'hyeongho',
              'youngme92': 'youngmo'
            };

            const githubUser = context.payload.pull_request.user.login;
            const expectedFileName = userMapping[githubUser];

            // outputs ì„¤ì •
            core.setOutput('user_name', githubUser);
            core.setOutput('file_name', expectedFileName || '');

            if (!expectedFileName) {
              const unregisteredMessages = [
                "ğŸ•µï¸ ìƒˆë¡œìš´ ìŠ¤í„°ë””ì›ì´ ë“±ì¥í–ˆë‚˜ìš”? ğŸ­ ê´€ë¦¬ìì—ê²Œ ì‚¬ìš©ì ë“±ë¡ì„ ë¶€íƒë“œë ¤ìš”!",
                "ğŸšª ì•„ì§ ì €í¬ ìŠ¤í„°ë”” ëª…ë‹¨ì— ì—†ìœ¼ì‹  ê²ƒ ê°™ì•„ìš”! ê´€ë¦¬ìì—ê²Œ ì—°ë½í•´ë³´ì„¸ìš”!",
                "ğŸª ì‹ ì… ìŠ¤í„°ë””ì› í™˜ì˜í•´ìš”! ğŸ‰ í•˜ì§€ë§Œ ë¨¼ì € ê´€ë¦¬ìì—ê²Œ ë“±ë¡ì„ ìš”ì²­í•´ì£¼ì„¸ìš”!",
                "ğŸ” ë¯¸ìŠ¤í„°ë¦¬í•œ ì‚¬ìš©ìë„¤ìš”! ğŸ•µï¸â€â™€ï¸ ê´€ë¦¬ìì—ê²Œ ë§¤í•‘ í…Œì´ë¸” ì¶”ê°€ë¥¼ ìš”ì²­í•´ì£¼ì„¸ìš”!"
              ];
              
              const randomUnregistered = unregisteredMessages[Math.floor(Math.random() * unregisteredMessages.length)];
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ­ ì–´ë¼? ìƒˆë¡œìš´ ì–¼êµ´ì´ë„¤ìš”!\n\n${randomUnregistered}\n\n---\n> ğŸ“ **ì°¸ê³ **: @${githubUser}ë‹˜ì„ ì‚¬ìš©ì ë§¤í•‘ í…Œì´ë¸”ì— ì¶”ê°€í•´ì£¼ì„¸ìš”!`
              });
              
              core.setOutput('result', 'unregistered');
              return;
            }

            // PRì—ì„œ ë³€ê²½ëœ íŒŒì¼ë“¤ í™•ì¸
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            // í•´ë‹¹ ì‚¬ìš©ìì˜ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ì´ ìˆëŠ”ì§€ ì²´í¬
            const userFile = files.data.find(file => 
              file.filename.includes(`${expectedFileName}.md`) && 
              (file.status === 'added' || file.status === 'modified')
            );

            if (userFile) {
              // íŒŒì¼ ë‚´ìš© ê¸¸ì´ ì²´í¬
              const fileContent = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: userFile.filename,
                ref: context.payload.pull_request.head.sha
              });
              
              const contentLength = Buffer.from(fileContent.data.content, 'base64').toString().length;
              
              const successMessages = [
                `ğŸ‰ ì™€! @${githubUser}ë‹˜ì˜ \`${expectedFileName}.md\` íŒŒì¼ì„ ë°œê²¬í–ˆì–´ìš”! ğŸ“šâœ¨`,
                `ğŸ” ì°¾ì•˜ë‹¤! @${githubUser}ë‹˜ì˜ í•™ìŠµ ì •ë¦¬ê°€ ì—¬ê¸° ìˆì—ˆë„¤ìš”! ğŸ¯`,
                `ğŸ“ @${githubUser}ë‹˜ì˜ \`${expectedFileName}.md\` íŒŒì¼ì´ ë°˜ì§ë°˜ì§ ë¹›ë‚˜ê³  ìˆì–´ìš”! âœ¨`,
                `ğŸª ì§œì”! @${githubUser}ë‹˜ì˜ í•™ìŠµ íŒŒì¼ì´ ë“±ì¥í–ˆì–´ìš”! ğŸ“–`
              ];
              
              const randomSuccess = successMessages[Math.floor(Math.random() * successMessages.length)];
              
              let message = randomSuccess;
              
              if (contentLength < 100) {
                message += `\n\nğŸ’¡ **ì°¸ê³ **: íŒŒì¼ì´ ì¡°ê¸ˆ ê°€ë²¼ìš´ ê²ƒ ê°™ì•„ìš”! ë” ë§ì€ í•™ìŠµ ë‚´ìš©ì´ ìˆìœ¼ë©´ ì¢‹ê² ì–´ìš”! (í˜„ì¬: ${contentLength}ì)`;
              } else {
                message += `\n\nğŸ‘ **í›Œë¥­í•´ìš”**: ì•Œì°¬ í•™ìŠµ ë‚´ìš©ì´ ê°€ë“í•˜ë„¤ìš”! (${contentLength}ì)`;
              }
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ¯ í•™ìŠµ íŒŒì¼ ì²´í¬ ì™„ë£Œ!\n\n${message}\n\n---\n> ğŸš€ **ë‹¤ìŒ ë‹¨ê³„**: AI ë¦¬ë·°ë´‡ì´ ê³§ ë“±ì¥í•  ì˜ˆì •ì´ì—ìš”!`
              });
              
              core.setOutput('result', 'success');
            } else {
              const noFileMessages = [
                `ğŸ“‚ ì–´ë¼? @${githubUser}ë‹˜ì˜ í•™ìŠµ íŒŒì¼ì´ ìˆ¨ë°”ê¼­ì§ˆí•˜ê³  ìˆë‚˜ìš”? ğŸ™ˆ \`${expectedFileName}.md\` íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”!`,
                `ğŸ” @${githubUser}ë‹˜ì˜ í•™ìŠµ íŒŒì¼ì„ ì°¾ëŠ” ì¤‘... ğŸ•µï¸ \`${expectedFileName}.md\` íŒŒì¼ì´ ì•„ì§ ë³´ì´ì§€ ì•Šë„¤ìš”!`,
                `ğŸ“ @${githubUser}ë‹˜ì˜ í•™ìŠµ ì •ë¦¬ê°€ íˆ¬ëª…ì¸ê°„ì´ ë˜ì—ˆë‚˜ë´ìš”! ğŸ‘» \`${expectedFileName}.md\` íŒŒì¼ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”!`,
                `ğŸ¯ íƒ€ê²Ÿì„ ë†“ì³¤ì–´ìš”! ğŸ¹ @${githubUser}ë‹˜ì˜ \`${expectedFileName}.md\` íŒŒì¼ì´ í•„ìš”í•´ìš”!`
              ];
              
              const randomNoFile = noFileMessages[Math.floor(Math.random() * noFileMessages.length)];
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ” í•™ìŠµ íŒŒì¼ì„ ì°¾ê³  ìˆì–´ìš”!\n\n${randomNoFile}\n\n---\n> ğŸ“ **í•„ìš”í•œ íŒŒì¼**: \`${expectedFileName}.md\`\n> ğŸ“ **ìœ„ì¹˜**: í•´ë‹¹ ì£¼ì°¨ í´ë” (ì˜ˆ: \`chapter-1-ì„¤ê³„ì™€ì•„í‚¤í…ì²˜ë€/${expectedFileName}.md\`)\n> ğŸ’¡ **tip**: íŒŒì¼ëª…ì´ ì •í™•í•œì§€ ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸í•´ì£¼ì„¸ìš”!`
              });
              
              core.setOutput('result', 'no_file');
            }
