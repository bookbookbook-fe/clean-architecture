name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      check_result: ${{ steps.file_check.outputs.result }}
      user_name: ${{ steps.file_check.outputs.user_name }}
      file_name: ${{ steps.file_check.outputs.file_name }}
      file_path: ${{ steps.file_check.outputs.file_path }}
    steps:
      - uses: actions/checkout@v4

      - name: Check user's study file
        id: file_check
        uses: actions/github-script@v6
        with:
          script: |
            const userMapping = {
              'JANGSEYEONG': 'seyeong',
              'sooyoung159': 'sooyoung',
              'kamja44': 'hyeongho',
              'youngme92': 'youngmo'
            };

            const githubUser = context.payload.pull_request.user.login;
            const expectedFileName = userMapping[githubUser];

            // outputs ì„¤ì • (í•­ìƒ ë¨¼ì € ì„¤ì •)
            core.setOutput('user_name', githubUser);
            core.setOutput('file_name', expectedFileName || '');
            core.setOutput('file_path', ''); // ì´ˆê¸°ê°’ ì„¤ì •

            console.log(`GitHub User: ${githubUser}`);
            console.log(`Expected File Name: ${expectedFileName}`);

            if (!expectedFileName) {
              const unregisteredMessages = [
                "ğŸ•µï¸ ìƒˆë¡œìš´ ìŠ¤í„°ë””ì›ì´ ë“±ì¥í–ˆë‚˜ìš”? ğŸ­ ê´€ë¦¬ìì—ê²Œ ì‚¬ìš©ì ë“±ë¡ì„ ë¶€íƒë“œë ¤ìš”!",
                "ğŸšª ì•„ì§ ì €í¬ ìŠ¤í„°ë”” ëª…ë‹¨ì— ì—†ìœ¼ì‹  ê²ƒ ê°™ì•„ìš”! ê´€ë¦¬ìì—ê²Œ ì—°ë½í•´ë³´ì„¸ìš”!",
                "ğŸª ì‹ ì… ìŠ¤í„°ë””ì› í™˜ì˜í•´ìš”! ğŸ‰ í•˜ì§€ë§Œ ë¨¼ì € ê´€ë¦¬ìì—ê²Œ ë“±ë¡ì„ ìš”ì²­í•´ì£¼ì„¸ìš”!",
                "ğŸ” ë¯¸ìŠ¤í„°ë¦¬í•œ ì‚¬ìš©ìë„¤ìš”! ğŸ•µï¸â€â™€ï¸ ê´€ë¦¬ìì—ê²Œ ë§¤í•‘ í…Œì´ë¸” ì¶”ê°€ë¥¼ ìš”ì²­í•´ì£¼ì„¸ìš”!"
              ];
              
              const randomUnregistered = unregisteredMessages[Math.floor(Math.random() * unregisteredMessages.length)];
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ­ ì–´ë¼? ìƒˆë¡œìš´ ì–¼êµ´ì´ë„¤ìš”!\n\n${randomUnregistered}\n\n---\n> ğŸ“ **ì°¸ê³ **: @${githubUser}ë‹˜ì„ ì‚¬ìš©ì ë§¤í•‘ í…Œì´ë¸”ì— ì¶”ê°€í•´ì£¼ì„¸ìš”!`
              });
              
              core.setOutput('result', 'unregistered');
              console.log('Setting result to: unregistered');
              
              // GitHub Environment File ë°©ì‹ë„ í•¨ê»˜ ì‚¬ìš©
              const fs = require('fs');
              fs.appendFileSync(process.env.GITHUB_OUTPUT, `result=unregistered\n`);
            } else {
              // PRì—ì„œ ë³€ê²½ëœ íŒŒì¼ë“¤ í™•ì¸
              const files = await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });

              console.log(`Found ${files.data.length} changed files:`);
              files.data.forEach(file => {
                console.log(`- ${file.filename} (${file.status})`);
              });

              // í•´ë‹¹ ì‚¬ìš©ìì˜ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ì´ ìˆëŠ”ì§€ ì²´í¬
              const userFile = files.data.find(file => {
                const fileName = file.filename.split('/').pop(); // ê²½ë¡œì—ì„œ íŒŒì¼ëª…ë§Œ ì¶”ì¶œ
                return fileName === `${expectedFileName}.md` && 
                       (file.status === 'added' || file.status === 'modified');
              });

              console.log(`Looking for file containing: ${expectedFileName}.md`);
              console.log(`User file found:`, userFile ? userFile.filename : 'none');

              if (userFile) {
                // íŒŒì¼ ê²½ë¡œë¥¼ outputì— ì €ì¥
                core.setOutput('file_path', userFile.filename);
                
                // GitHub Environment File ë°©ì‹ìœ¼ë¡œë„ ì €ì¥
                const fs = require('fs');
                fs.appendFileSync(process.env.GITHUB_OUTPUT, `file_path=${userFile.filename}\n`);
                
                // íŒŒì¼ ë‚´ìš© ê¸¸ì´ ì²´í¬
                try {
                  const fileContent = await github.rest.repos.getContent({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    path: userFile.filename,
                    ref: context.payload.pull_request.head.sha
                  });
                  
                  const contentLength = Buffer.from(fileContent.data.content, 'base64').toString().length;
                  
                  const successMessages = [
                    `ğŸ‰ ì™€! @${githubUser}ë‹˜ì˜ \`${expectedFileName}.md\` íŒŒì¼ì„ ë°œê²¬í–ˆì–´ìš”! ğŸ“šâœ¨`,
                    `ğŸ” ì°¾ì•˜ë‹¤! @${githubUser}ë‹˜ì˜ í•™ìŠµ ì •ë¦¬ê°€ ì—¬ê¸° ìˆì—ˆë„¤ìš”! ğŸ¯`,
                    `ğŸ“ @${githubUser}ë‹˜ì˜ \`${expectedFileName}.md\` íŒŒì¼ì´ ë°˜ì§ë°˜ì§ ë¹›ë‚˜ê³  ìˆì–´ìš”! âœ¨`,
                    `ğŸª ì§œì”! @${githubUser}ë‹˜ì˜ í•™ìŠµ íŒŒì¼ì´ ë“±ì¥í–ˆì–´ìš”! ğŸ“–`
                  ];
                  
                  const randomSuccess = successMessages[Math.floor(Math.random() * successMessages.length)];
                  
                  let message = randomSuccess;
                  
                  if (contentLength < 100) {
                    message += `\n\nğŸ’¡ **ì°¸ê³ **: íŒŒì¼ì´ ì¡°ê¸ˆ ê°€ë²¼ìš´ ê²ƒ ê°™ì•„ìš”! ë” ë§ì€ í•™ìŠµ ë‚´ìš©ì´ ìˆìœ¼ë©´ ì¢‹ê² ì–´ìš”! (í˜„ì¬: ${contentLength}ì)`;
                  } else {
                    message += `\n\nğŸ‘ **í›Œë¥­í•´ìš”**: ì•Œì°¬ í•™ìŠµ ë‚´ìš©ì´ ê°€ë“í•˜ë„¤ìš”! (${contentLength}ì)`;
                  }
                  
                  await github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: `## ğŸ¯ í•™ìŠµ íŒŒì¼ ì²´í¬ ì™„ë£Œ!\n\n${message}\n\n---\n> ğŸš€ **ë‹¤ìŒ ë‹¨ê³„**: AI ë¦¬ë·°ë´‡ì´ ê³§ ë“±ì¥í•  ì˜ˆì •ì´ì—ìš”!`
                  });
                  
                  core.setOutput('result', 'success');
                  console.log('Setting result to: success');
                  
                  // GitHub Environment File ë°©ì‹ë„ í•¨ê»˜ ì‚¬ìš©
                  fs.appendFileSync(process.env.GITHUB_OUTPUT, `result=success\n`);
                } catch (error) {
                  console.error('Error reading file content:', error);
                  core.setOutput('result', 'error');
                  console.log('Setting result to: error');
                  
                  // GitHub Environment File ë°©ì‹ë„ í•¨ê»˜ ì‚¬ìš©
                  const fs = require('fs');
                  fs.appendFileSync(process.env.GITHUB_OUTPUT, `result=error\n`);
                }
              } else {
                const noFileMessages = [
                  `ğŸ“‚ ì–´ë¼? @${githubUser}ë‹˜ì˜ í•™ìŠµ íŒŒì¼ì´ ìˆ¨ë°”ê¼­ì§ˆí•˜ê³  ìˆë‚˜ìš”? ğŸ™ˆ \`${expectedFileName}.md\` íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”!`,
                  `ğŸ” @${githubUser}ë‹˜ì˜ í•™ìŠµ íŒŒì¼ì„ ì°¾ëŠ” ì¤‘... ğŸ•µï¸ \`${expectedFileName}.md\` íŒŒì¼ì´ ì•„ì§ ë³´ì´ì§€ ì•Šë„¤ìš”!`,
                  `ğŸ“ @${githubUser}ë‹˜ì˜ í•™ìŠµ ì •ë¦¬ê°€ íˆ¬ëª…ì¸ê°„ì´ ë˜ì—ˆë‚˜ë´ìš”! ğŸ‘» \`${expectedFileName}.md\` íŒŒì¼ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”!`,
                  `ğŸ¯ íƒ€ê²Ÿì„ ë†“ì³¤ì–´ìš”! ğŸ¹ @${githubUser}ë‹˜ì˜ \`${expectedFileName}.md\` íŒŒì¼ì´ í•„ìš”í•´ìš”!`
                ];
                
                const randomNoFile = noFileMessages[Math.floor(Math.random() * noFileMessages.length)];
                
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: `## ğŸ” í•™ìŠµ íŒŒì¼ì„ ì°¾ê³  ìˆì–´ìš”!\n\n${randomNoFile}\n\n---\n> ğŸ“ **í•„ìš”í•œ íŒŒì¼**: \`${expectedFileName}.md\`\n> ğŸ“ **ìœ„ì¹˜**: í•´ë‹¹ ì£¼ì°¨ í´ë” (ì˜ˆ: \`week-1-ì•„í‚¤í…ì²˜ê¸°ì´ˆ/${expectedFileName}.md\`)\n> ğŸ’¡ **tip**: íŒŒì¼ëª…ì´ ì •í™•í•œì§€ ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸í•´ì£¼ì„¸ìš”!`
                });
                
                core.setOutput('result', 'no_file');
                console.log('Setting result to: no_file');
                
                // GitHub Environment File ë°©ì‹ë„ í•¨ê»˜ ì‚¬ìš©
                const fs = require('fs');
                fs.appendFileSync(process.env.GITHUB_OUTPUT, `result=no_file\n`);
              }
            }

      - name: Debug outputs (check job)
        run: |
          echo "Check result: ${{ steps.file_check.outputs.result }}"
          echo "User name: ${{ steps.file_check.outputs.user_name }}"
          echo "File name: ${{ steps.file_check.outputs.file_name }}"
          echo "File path: ${{ steps.file_check.outputs.file_path }}"

      - name: Verify outputs are set
        run: |
          echo "GITHUB_OUTPUT file contents:"
          cat $GITHUB_OUTPUT || echo "No GITHUB_OUTPUT file"

  ai-review:
    needs: check
    runs-on: ubuntu-latest
    # file_pathê°€ ìˆì„ ë•Œë§Œ ì‹¤í–‰ (ë¹ˆ ë¬¸ìì—´ì´ë‚˜ nullì´ë©´ ìŠ¤í‚µ)
    if: ${{ needs.check.outputs.file_path != '' && needs.check.outputs.file_path != null }}
    steps:
      - uses: actions/checkout@v4

      - name: Debug outputs (ai-review job)
        run: |
          echo "Check result: ${{ needs.check.outputs.check_result }}"
          echo "User name: ${{ needs.check.outputs.user_name }}"
          echo "File name: ${{ needs.check.outputs.file_name }}"
          echo "File path: ${{ needs.check.outputs.file_path }}"

      - name: AI Review
        uses: actions/github-script@v6
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const checkResult = '${{ needs.check.outputs.check_result }}';
            const githubUser = '${{ needs.check.outputs.user_name }}';
            const expectedFileName = '${{ needs.check.outputs.file_name }}';
            const filePath = '${{ needs.check.outputs.file_path }}';

            console.log(`Check result: ${checkResult}`);
            console.log(`AI Review starting for user: ${githubUser}`);
            console.log(`Expected file name: ${expectedFileName}`);
            console.log(`File path: ${filePath}`);

            if (!expectedFileName || !filePath) {
              console.log('Missing required data - skipping AI review');
              return;
            }

            // íŒŒì¼ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
            try {
              const fileContent = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: filePath,
                ref: context.payload.pull_request.head.sha
              });

              const markdownContent = Buffer.from(fileContent.data.content, 'base64').toString();
              console.log(`File content length: ${markdownContent.length} characters`);

              // Gemini API í˜¸ì¶œ
              const geminiApiKey = process.env.GEMINI_API_KEY;
              if (!geminiApiKey) {
                console.error('GEMINI_API_KEY is not set');
                throw new Error('GEMINI_API_KEY is missing');
              }

              const prompt = `
              ë‹¤ìŒì€ í´ë¦° ì•„í‚¤í…ì²˜ ìŠ¤í„°ë””ì—ì„œ ì™„ì„±ëœ í•™ìŠµ ì •ë¦¬ ë‚´ìš©ì…ë‹ˆë‹¤.

              ${markdownContent}

              ì´ í•™ìŠµ ì •ë¦¬ë¥¼ ì¹œê·¼í•˜ë©´ì„œ ì¬ë¯¸ìˆê³  ìœ ë¨¸ëŸ¬ìŠ¤í•˜ê²Œ ë¦¬ë·°í•´ì£¼ì„¸ìš”! ì•„ë˜ í˜•ì‹ì„ **ë°˜ë“œì‹œ** ì§€ì¼œì£¼ì„¸ìš”:

              ## ğŸ“ ìš”ì•½
              (í•µì‹¬ ë‚´ìš©ì„ 1-2ì¤„ë¡œ ê°„ë‹¨íˆ)

              ## âœ¨ ì˜í•˜ì‹  ì 
              - (ì˜í•œ ì  1 - êµ¬ì²´ì ìœ¼ë¡œ ì˜ ì •ë¦¬ëœ ë¶€ë¶„ ìœ ë¨¸ì™€ í•¨ê»˜ ê°„ë‹¨íˆ)
              - (ì˜í•œ ì  2 - ì¸ìƒì ì¸ ì¸ì‚¬ì´íŠ¸ë‚˜ ì´í•´ë„ê°€ ë‹ë³´ì´ëŠ” ë¶€ë¶„ ê°„ë‹¨íˆ)  
              - (ì˜í•œ ì  3 - ê¸°íƒ€ ì¥ì ì´ë‚˜ ë…¸ë ¥ì´ ë³´ì´ëŠ” ë¶€ë¶„ ì¬ë¯¸ìˆëŠ” í‘œí˜„ìœ¼ë¡œ ê°„ë‹¨íˆ)

              ## ğŸ¤” ì´ëŸ° ê´€ì ì€ ì–´ë– ì„¸ìš”?
              - (ì¶”ê°€ ê´€ì  1 - ê°„ë‹¨í•œ ì œì•ˆ)
              - (ì¶”ê°€ ê´€ì  2 - ì‹¤ë¬´ ì—°ê²°ì )

              ## ğŸš€ í•œë§ˆë””
              (ê²©ë ¤ì™€ ë™ê¸°ë¶€ì—¬ê°€ ë˜ëŠ” ë”°ëœ»í•˜ë©´ì„œë„ ìœ ë¨¸ëŸ¬ìŠ¤í•œ ë©”ì‹œì§€ - 2ì¤„ ì´ë‚´)

              ---
              > ğŸ¤– **AI ë¦¬ë·°ë´‡**: (ì´ í•™ìŠµ ì •ë¦¬ë¥¼ ì¬ì¹˜ìˆëŠ” í•œ ì¤„ì˜ ì‹œë‚˜ ëª…ì–¸ì²˜ëŸ¼ ìš”ì•½í•œ ê°ì„±ì ì¸ ë©”ì‹œì§€)

              **ì¤‘ìš”**: 
              1. ë°˜ë“œì‹œ ìœ„ì˜ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì„ ì§€ì¼œì„œ ë‹µë³€í•´ì£¼ì„¸ìš”
              2. ê° í•­ëª©ì€ ê°„ê²°í•˜ê²Œ 1-2ì¤„ë¡œ ì‘ì„± (ìµœëŒ€ 3ì¤„)
              3. ì¹œêµ¬ì²˜ëŸ¼ ì¹œê·¼í•˜ê³  ê²©ë ¤í•˜ëŠ” í†¤ì´ë‚˜ ìœ ë¨¸ëŸ¬ìŠ¤í•˜ê²Œ ì‘ì„± (ì¡´ëŒ“ë§ ìœ ì§€)
              4. ì´ëª¨ì§€ë‚˜ ì¬ë¯¸ìˆëŠ” ë¹„ìœ  í™œìš© í™˜ì˜
              5. ë§¨ ë§ˆì§€ë§‰ ì¸ìš©êµ¬(> ğŸ¤– **AI ë¦¬ë·°ë´‡**:)ëŠ” ê¼­ í¬í•¨í•˜ê³ , ì‹œì ì´ê³  ê°ì„±ì ì¸ í•œ ì¤„ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”
              6. ê° ì„¹ì…˜ì€ ##ìœ¼ë¡œ ì‹œì‘í•˜ê³ , ë¦¬ìŠ¤íŠ¸ëŠ” -ë‚˜ **ë³¼ë“œ**ë¥¼ í™œìš©í•´ì£¼ì„¸ìš”
              `;

              console.log('Calling Gemini API...');
              const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  contents: [{
                    parts: [{
                      text: prompt
                    }]
                  }]
                })
              });
              
              if (!response.ok) {
                const errorText = await response.text();
                console.error(`Gemini API error: ${response.status} - ${errorText}`);
                throw new Error(`Gemini API error: ${response.status}`);
              }
              
              const data = await response.json();
              const aiReview = data.candidates[0].content.parts[0].text;
              
              console.log('AI review generated successfully');
              
              // AI ë¦¬ë·°ë¥¼ PRì— ëŒ“ê¸€ë¡œ ì¶”ê°€
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ“ AI í•™ìŠµ ë¦¬ë·°\n\n${aiReview}`
              });
              
              console.log('AI review comment posted successfully');
              
            } catch (error) {
              console.error('Error in AI review process:', error);
              
              // API ì‹¤íŒ¨ ì‹œ ì¬ë¯¸ìˆëŠ” ë©”ì‹œì§€
              const funnyMessages = [
                "ğŸ¤– AIê°€ ì»¤í”¼ë¥¼ ë§ˆì‹œëŸ¬ ê°”ë‚˜ë´ìš”... â˜• í•˜ì§€ë§Œ ì—¬ëŸ¬ë¶„ì˜ í•™ìŠµ ì—´ì •ì€ ì´ë¯¸ ì¶©ë¶„íˆ í›Œë¥­í•´ìš”!",
                "ğŸŒ™ AIê°€ ì ê¹ ì¡¸ê³  ìˆëŠ” ê²ƒ ê°™ì•„ìš”... ğŸ’¤ ëŒ€ì‹  ì œê°€ ë§ì”€ë“œë¦¬ìë©´, ê¾¸ì¤€íˆ í•™ìŠµí•˜ëŠ” ëª¨ìŠµì´ ì •ë§ ë©‹ì ¸ìš”!",
                "ğŸš€ AIê°€ ìš°ì£¼ì—¬í–‰ì„ ë– ë‚œ ê²ƒ ê°™ë„¤ìš”... ğŸ›¸ í•˜ì§€ë§Œ ì—¬ëŸ¬ë¶„ì€ ì´ë¯¸ í´ë¦° ì•„í‚¤í…ì²˜ ìš°ì£¼ë¥¼ íƒí—˜í•˜ê³  ê³„ì‹œì£ !",
                "ğŸ• AIê°€ ì ì‹¬ ë¨¹ìœ¼ëŸ¬ ê°„ ê²ƒ ê°™ì•„ìš”... ğŸ½ï¸ ê·¸ë™ì•ˆ ì—¬ëŸ¬ë¶„ì˜ í•™ìŠµ ì •ë¦¬ë¥¼ ë³´ë‹ˆ ì •ë§ ì•Œì°¨ê²Œ ê³µë¶€í•˜ì…¨ë„¤ìš”!",
                "ğŸ® AIê°€ ì ê¹ ê²Œì„í•˜ëŸ¬ ê°„ ê²ƒ ê°™ì•„ìš”... ğŸ•¹ï¸ í•˜ì§€ë§Œ ì—¬ëŸ¬ë¶„ì€ ì§„ì§œ ê²Œì„ - í´ë¦° ì•„í‚¤í…ì²˜ ë§ˆìŠ¤í„°í•˜ê¸°ë¥¼ í”Œë ˆì´ ì¤‘ì´ì‹œì£ !"
              ];
              
              const randomMessage = funnyMessages[Math.floor(Math.random() * funnyMessages.length)];
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ“ AI í•™ìŠµ ë¦¬ë·° (ì˜¤ë¥˜ ë°œìƒ)\n\n${randomMessage}\n\n---\n> âš ï¸ **ì°¸ê³ **: AI API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì§€ë§Œ, ì—¬ëŸ¬ë¶„ì˜ í•™ìŠµì€ ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤! ğŸ‰\n> ğŸ”§ **ì˜¤ë¥˜ ì •ë³´**: ${error.message}`
              });
            }
